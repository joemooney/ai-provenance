# Testing Procedures

## Test Pyramid

```
        /\
       /E2E\
      /------\
     /  Inte- \
    /  gration \
   /------------\
  /     Unit     \
 /----------------\
```

- **70% Unit tests**: Fast, isolated, focused
- **20% Integration tests**: Component interactions
- **10% E2E tests**: Full system workflows

## Test Categories

### Unit Tests

**Purpose**: Test individual functions/classes in isolation

**Location**: `tests/unit/`

**Naming**: `test_<module>_<function>.py`

**Example**:
```python
# tests/unit/test_auth_jwt.py

def test_generate_jwt_token():
    """Test JWT token generation."""
    token = generate_jwt("user123")
    assert validate_jwt(token) == "user123"
```

### Integration Tests

**Purpose**: Test component interactions

**Location**: `tests/integration/`

**Requirements**: May need database, external services

### E2E Tests

**Purpose**: Test full user workflows

**Location**: `tests/e2e/`

**Requirements**: Full system running

## Running Tests

```bash
# All tests
pytest

# Specific category
pytest tests/unit/
pytest tests/integration/

# With coverage
pytest --cov=src --cov-report=html

# AI provenance validation
ai-prov validate --require-tests
```

## Test Case Documentation

Every test should:

1. Have a clear name describing what it tests
2. Include a docstring explaining the test
3. Be linked to a requirement (via `# trace:SPEC-XXX`)
4. Test one thing (single responsibility)

## AI-Generated Tests

Tests generated by AI should:

1. Be tagged with AI metadata
2. Be reviewed for correctness and completeness
3. Include edge cases, not just happy path
4. Link to the requirement they verify

Example:
```python
# ai:claude:high | trace:SPEC-089 | test:TC-210

def test_jwt_expiration():
    """Test that JWT tokens expire correctly."""
    # AI-generated test for JWT expiration
    token = generate_jwt("user123", exp_minutes=1)

    # Token should be valid immediately
    assert validate_jwt(token) == "user123"

    # Simulate time passing (mock time)
    with freeze_time(datetime.now() + timedelta(minutes=2)):
        with pytest.raises(ExpiredTokenError):
            validate_jwt(token)
```

## Continuous Integration

All tests must pass before merging:

```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run tests
        run: pytest --cov --cov-fail-under=80
      - name: Validate AI provenance
        run: ai-prov validate --require-tests
```

## Coverage Requirements

- **Overall**: Minimum 80% coverage
- **New code**: Minimum 90% coverage
- **Critical paths**: 100% coverage
- **AI-generated code**: 95% coverage (extra scrutiny)
